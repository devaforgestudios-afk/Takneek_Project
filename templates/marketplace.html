{% extends "layout.html" %}
{% block title %}Marketplace | Kalakar Sahayak{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/marketplace.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}">
{% endblock %}

{% block content %}

<div class="hero-section">
    <h1 class="hero-title">Artisan <span class="marketplace">Marketplace</span></h1>
    <p class="hero-subtitle">Discover authentic handcrafted treasures directly from master artisans across India</p>
    
    <div class="search-container">
        <div class="search-box">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <circle cx="11" cy="11" r="8" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="text" id="searchInput" class="search-input" placeholder="Search for pottery, textiles, jewelry...">
        </div>
    </div>
</div>

<div class="container">
    <!-- Filter Bar -->
<div class="filter-bar">
    <span class="material-symbols-outlined notranslate filter-icon">tune</span>
    <button class="filter-btn active" data-category="all">All</button>
    <button class="filter-btn" data-category="painting">Painting</button>
    <button class="filter-btn" data-category="pottery">Pottery</button>
    <button class="filter-btn" data-category="textile">Textile</button>
    <button class="filter-btn" data-category="jewelry">Jewelry</button>
    <button class="filter-btn" data-category="woodwork">Woodwork</button>
    <button class="filter-btn" data-category="metalwork">Metalwork</button>
    
    <div class="sort-section">
        <label for="sort">Sort by:</label>
        <select id="sort" class="sort-select">
            <option value="popular">Popular</option>
            <option value="newest">Newest First</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
            <option value="rating">Highest Rated</option>
        </select>
    </div>
</div>

    <hr style="border: 1px solid #ded3c2; margin-bottom: 40px;">

    <!-- Product Count -->
    <div class="product-count">Showing <span id="productCount">0</span> products</div>

    <!-- Products Grid -->
    <div id="productsContainer" class="products-grid">
        <div class="loader-wrapper">
            <div class="loader-container">
                <div class="loader-ring"></div>
                <div class="loader-mandala"></div>
                <div class="loader-center"></div>
                <div class="orbit-dot"></div>
                <div class="orbit-dot"></div>
                <div class="orbit-dot"></div>
                <div class="orbit-dot"></div>
                <div class="loader-text">Loading Artworks</div>
            </div>
        </div>
    </div>
</div>


<script>
    let allProducts = [];
let filteredProducts = [];
let currentCategory = 'all';
let currentSort = 'popular';
let searchQuery = '';

// Fetch products from API
async function fetchProducts() {
    try {
        const response = await fetch('/api/products');
        if (!response.ok) throw new Error('Failed to fetch products');
        allProducts = await response.json();
        filteredProducts = [...allProducts];
        displayProducts();
    } catch (error) {
        console.error('Error fetching products:', error);
        document.getElementById('productsContainer').innerHTML = 
            `<div class="empty-state">
                <span class="material-symbols-outlined notranslate">error</span>
                <h3>Failed to load products</h3>
                <p>Please try again later</p>
            </div>`;
    }
}

// Display products
function displayProducts() {
    const container = document.getElementById('productsContainer');
    const productCount = document.getElementById('productCount');
    
    if (filteredProducts.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <span class="material-symbols-outlined notranslate">search_off</span>
                <h3>No products found</h3>
                <p>Try adjusting your filters or search query</p>
            </div>`;
        productCount.textContent = '0';
        return;
    }

    productCount.textContent = filteredProducts.length;

    container.innerHTML = filteredProducts.map(product => `
        <div class="product-card" onclick="viewProduct('${product.id}')">
            <div class="product-image-container">
                <img src="${product.image}" alt="${product.name}" class="product-image" 
                     onerror="this.src='https://via.placeholder.com/400x280/f9fafb/9ca3af?text=No+Image'">
                ${product.authentic ? '<span class="authentic-badge">Authentic</span>' : ''}
                ${product.images.length > 1 ? `<span class="image-count-badge">${product.images.length} photos</span>` : ''}
            </div>
            <div class="product-details">
                <div class="product-header">
                    <div style="flex: 1;">
                        <h3 class="product-name">${product.name}</h3>
                        <span class="product-artist">by ${product.artist}</span>
                    </div>
                    ${product.price > 0 ? 
                        `<div class="product-price">â‚¹${product.price.toLocaleString()}</div>` : 
                        `<div class="product-price" style="font-size: 0.9rem; color: #999;">Contact for price</div>`
                    }
                </div>
                <div class="product-meta">
                    <span class="product-category">${product.category}</span>
                    <span class="product-material">${product.material}</span>
                </div>
                <div class="product-location">
                    <span class="material-symbols-outlined notranslate">location_on</span>
                    <span>${product.location}</span>
                </div>
                <div class="product-description-preview">
                    ${product.description.substring(0, 100)}${product.description.length > 100 ? '...' : ''}
                </div>
                <div class="product-stats">
                    <div class="stat-item">
                        <span class="material-symbols-outlined notranslate">visibility</span>
                        <span>${product.views || 0}</span>
                    </div>
                    <div class="stat-item">
                        <span class="material-symbols-outlined notranslate">favorite</span>
                        <span>${product.likes || 0}</span>
                    </div>
                    <div class="rating-stars">
                        <span class="material-symbols-outlined notranslate rating-star">star</span>
                        <span class="rating-value">${product.rating}</span>
                    </div>
                </div>
                <button class="buy-btn" onclick="event.stopPropagation(); buyProduct('${product.id}', '${product.name}', ${product.price})">
                    ${product.price > 0 ? 'Buy Product' : 'Contact Artist'}
                </button>
            </div>
        </div>
    `).join('');
}

// Apply filters and sorting
async function applyFilters() {
    const searchQuery = document.getElementById('searchInput').value;

    if (searchQuery) {
        try {
            const response = await fetch(`/api/ai-search?query=${searchQuery}&category=${currentCategory}`);
            if (!response.ok) throw new Error('AI search failed');
            filteredProducts = await response.json();
        } catch (error) {
            console.error('Error during AI search:', error);
            filteredProducts = [];
        }
    } else {
        filteredProducts = [...allProducts];
        if (currentCategory !== 'all') {
            filteredProducts = filteredProducts.filter(p => 
                p.category.toLowerCase() === currentCategory.toLowerCase()
            );
        }
    }

    switch(currentSort) {
        case 'price-low':
            filteredProducts.sort((a, b) => a.price - b.price);
            break;
        case 'price-high':
            filteredProducts.sort((a, b) => b.price - a.price);
            break;
        case 'rating':
            filteredProducts.sort((a, b) => b.rating - a.rating);
            break;
        case 'popular':
            filteredProducts.sort((a, b) => (b.views + b.likes) - (a.views + a.likes));
            break;
        case 'newest':
            filteredProducts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            break;
    }

    displayProducts();
}

// View product details
function viewProduct(productId) {
    // You can implement a modal or redirect to product detail page
    window.location.href = `/product/${productId}`;
}

// Buy product function
function buyProduct(productId, productName, price) {
    if (price === 0) {
        alert(`Please contact the artist directly for pricing information about: ${productName}`);
    } else {
        viewProduct(productId);
    }
}

// Like product
async function likeProduct(productId, event) {
    event.stopPropagation();
    try {
        const response = await fetch(`/api/product/${productId}/like`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            // Update the like count in the UI
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                product.likes = data.likes;
                displayProducts();
            }
        }
    } catch (error) {
        console.error('Error liking product:', error);
    }
}

// Event listeners
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentCategory = this.dataset.category;
        applyFilters();
    });
});

document.getElementById('sort').addEventListener('change', function() {
    currentSort = this.value;
    applyFilters();
});

document.getElementById('searchInput').addEventListener('input', function(e) {
    applyFilters();
});

// Initialize
fetchProducts();
</script>

{% endblock %}